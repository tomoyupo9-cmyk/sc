<!doctype html>
<html lang="ja">
<head>
<meta http-equiv="Cache-Control" content="no-store">
<meta http-equiv="Pragma" content="no-cache">
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚° ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
<style>
  :root{
    --ink:#1f2937; --muted:#6b7280; --bg:#f9fafb; --line:#e5e7eb;
    --blue:#0d3b66; --green:#15803d; --orange:#b45309; --yellow:#a16207;
    --hit:#ffe6ef; --rowhover:#f6faff;
  }

  /* å…¨ä½“ */
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif;
    margin:16px; color:var(--ink); background:#fff;
  }

  nav{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  nav a{padding:6px 10px;border-radius:8px;text-decoration:none;background:#e1e8f0;color:#1f2d3d;font-weight:600}
  nav a.active{background:var(--blue);color:#fff}

  .toolbar{display:flex;gap:14px;align-items:center;margin:8px 0 10px;flex-wrap:wrap}
  .toolbar input[type="text"],.toolbar input[type="number"]{padding:6px 10px;border:1px solid #ccd;border-radius:8px;background:#fff}
  .toolbar input[type="number"]{width:80px}
  .btn{background:var(--blue);color:#fff;border:none;border-radius:8px;padding:6px 12px;cursor:pointer;font-weight:600}

  /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ©ãƒƒãƒ‘ï¼ˆè§’ä¸¸ï¼‹æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
  .tbl-wrap{
    border-radius:10px;
    overflow:auto; /* ç¸¦æ¨ª */
    -webkit-overflow-scrolling:touch;
    background:#fff;
    box-shadow:0 0 0 1px var(--line) inset;
    max-height:70vh;
  }

  /* ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€šï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰ */
  .tbl{ border-collapse:collapse; width:100%; background:#fff; }
  .tbl th,.tbl td{
    border-bottom:1px solid var(--line);
    padding:4px 6px;
    font-size:0.85em;
    vertical-align:top;
  }
  .tbl tbody tr:nth-child(even){background:#fcfdff}
  .tbl tbody tr:hover{background:var(--rowhover)}
  .tbl th.sortable{cursor:pointer;user-select:none}
  .tbl th.sortable .arrow{margin-left:6px;font-size:11px;color:#666}
  .num{text-align:right}
  .muted{color:var(--muted)}
  .hidden{display:none}
  .count{margin-left:6px;color:var(--muted)}
  .pager{display:flex;gap:8px;align-items:center}
  tr.hit>td{background:var(--hit)}

  /* ãƒãƒƒã‚¸ */
  .badge{display:inline-flex;gap:6px;align-items:center;padding:2px 8px;border-radius:999px;font-size:12px;line-height:1;font-weight:700}
  .b-green{background:#e7f6ed;color:var(--green);border:1px solid #cceedd}
  .b-orange{background:#fff4e6;color:#b45309;border:1px solid #ffe2c2}
  .b-yellow{background:#fff9db;color:var(--yellow);border:1px solid #ffe9a8}
  .b-gray{background:#eef2f7;color:#475569;border:1px solid #dbe4ef}

  /* æ¨å¥¨ãƒãƒƒã‚¸ */
  .rec-badge{display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; line-height:1; white-space:nowrap;}
  .rec-strong{ background:#e7f6ed; color:#166534; border:1px solid #cceedd; }
  .rec-small { background:#fff4e6; color:#9a3412; border:1px solid #ffe2c2; }
  .rec-watch { background:#eef2f7; color:#475569; border:1px solid #dbe4ef; }
  .rec-dot{ display:inline-block; width:6px; height:6px; border-radius:50%; background:currentColor;}

  /* ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®šï¼ˆå€™è£œä¸€è¦§ / å…¨ã‚«ãƒ©ãƒ ï¼‰ */
  #tbl-candidate thead th,
  #tbl-allcols  thead th{
    position:sticky;
    position:-webkit-sticky;
    top:0;
    background:#fff;
    z-index:2;
    border-bottom:2px solid #ccc;
  }

  /* ãƒ˜ãƒ«ãƒ—ï¼ˆå°çª“ï¼‹æš—å¹•ï¼‰ */
  .help-backdrop{
    position:fixed; inset:0; background:rgba(17,24,39,.45);
    z-index:9998; display:none;
  }
  .help-pop{
    position:absolute; z-index:9999; background:#fff; border:1px solid #e5e7eb;
    border-radius:12px; box-shadow:0 12px 32px rgba(0,0,0,.18);
    padding:12px 14px 14px; font-size:13px; line-height:1.55;
    display:none; width:clamp(720px, 90vw, 1200px);
  }
  .help-pop .help-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px; font-weight:700;}
  .help-pop .help-close{ display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:6px; cursor:pointer; user-select:none; font-weight:700;}
  .help-pop .help-close:hover{ background:#f3f4f6; }

  /* ï¼Ÿã‚¢ã‚¤ã‚³ãƒ³ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«/ãƒ„ãƒ¼ãƒ«ãƒãƒ¼å…±é€šï¼‰ */
  .qhelp{ display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; margin-left:6px;
    border-radius:50%; border:1px solid #cbd5e1; font-size:12px; cursor:pointer; background:#eef2ff; color:#334155; font-weight:700; line-height:1;}
  .qhelp:hover{ background:#e0e7ff; }

  /* 1è¡Œå›ºå®šï¼ˆæ”¹è¡Œã¯æ½°ã™ï¼‰ */
  #tbl-candidate td, #tbl-candidate th,
  #tbl-allcols  td, #tbl-allcols  th{ white-space:nowrap !important; word-break:keep-all !important; }
  #tbl-candidate td br, #tbl-candidate th br,
  #tbl-allcols  td br, #tbl-allcols  th br{ display:none !important; }

  /* åˆ¤å®šç†ç”±ã¯æ¥µå°ã§æŠ˜ã‚Šè¿”ã—å¯ */
  th.reason-col, td.reason-col{ font-size:0.78em; line-height:1.2; white-space:normal !important; word-break:break-word !important; }

  .mini{ font-size:10px; color:var(--muted); }

  /* ã‚³ãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼ãƒªãƒ³ã‚¯ */
  .copylink{ color:var(--blue); text-decoration:underline; cursor:pointer; }
  .copylink.ok{ color:var(--green); text-decoration:none; font-weight:700; }

  /* äºˆæ¸¬ã‚¿ãƒ–ï¼šç†ç”±/ãƒ’ãƒ³ãƒˆã®å¼·èª¿ */
  .reason-col,.hint-col {vertical-align: top;}
  .reason-box{ display:inline-block; padding:6px 8px; border-radius:10px; background:#fff9db; line-height:1.4; white-space: pre-wrap; }

  /* è²¡å‹™ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè²¡å‹™ãƒªãƒ³ã‚¯å³ï¼‰ */
  .fn-note{
    color:#b91c1c; font-weight:700; font-size:0.78em; margin-left:8px;
    white-space:pre-wrap; overflow:visible; text-overflow:clip; display:inline-block;
    max-width:clamp(600px, 60vw, 1200px); vertical-align:bottom;
  }

  /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—/ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã¯ã‚¯ãƒªãƒƒã‚¯è²«é€š */
  .tooltip, .popover { pointer-events:none; }
  
  /* æ±ºç®—ã‚¿ãƒ–ï¼šåˆ¤å®šç†ç”±ã‚’ã‚¿ã‚°é¢¨ã«è¡¨ç¤º */
  .reason-tags{ display:flex; flex-wrap:wrap; gap:6px; }
  .reason-tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px;
    background:#eef2ff; border:1px solid #c7d2fe; color:#334155; white-space:nowrap; }

</style>
</head>

<body>
  <nav>
    <a href="#" id="lnk-cand" class="active">å€™è£œä¸€è¦§</a>
    <a href="#" id="lnk-tmr">æ˜æ—¥ç”¨</a>
    <a href="#" id="lnk-all">å…¨ã‚«ãƒ©ãƒ </a>
    <a href="#" id="lnk-earn">æ±ºç®—(å®Ÿç¸¾)</a>
    <a href="#" id="lnk-preearn">æ±ºç®—(äºˆæ¸¬)</a>
    {% if include_log %}<a href="#" id="lnk-log">signals_log</a>{% endif %}
    <span class="mini" style="margin-left:auto">build: {{ build_id }}</span>
  </nav>

  <div id="toolbar" class="toolbar">
    <label><input type="checkbox" id="f_shodou"> åˆå‹•ã®ã¿</label>
    <label><input type="checkbox" id="f_tei"> åº•æ‰“ã¡ã®ã¿</label>
    <label><input type="checkbox" id="f_both"> ä¸¡ç«‹ã®ã¿</label>
    <label><input type="checkbox" id="f_rightup"> å³è‚©ä¸ŠãŒã‚Šã®ã¿</label>
    <label><input type="checkbox" id="f_early"> æ—©æœŸã®ã¿</label>
    <label><input type="checkbox" id="f_etype"> æ—©æœŸç¨®åˆ¥ã‚ã‚Š</label>
    <label><input type="checkbox" id="f_recstrong"> ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›ã®ã¿</label>
    <label><input type="checkbox" id="f_smallpos"> å°å£ææ¡ˆã®ã¿</label>
    <label><input type="checkbox" id="f_noshor"> ç©ºå£²ã‚Šæ©Ÿé–¢ãªã—ã®ã¿</label>
    <label><input type="checkbox" id="f_opratio"> å‰²å®‰ï¼ˆå–¶åˆ©å¯¾æ™‚ä¾¡10%ä»¥ä¸Šï¼‰ã®ã¿</label>
    <label><input type="checkbox" id="f_hit"> å½“ãŸã‚Šã®ã¿</label>
    <div class="toolbar early-filter">
      <label class="ef-chk"><input type="checkbox" value="ãƒ–ãƒ¬ã‚¤ã‚¯" ><span>ãƒ–ãƒ¬ã‚¤ã‚¯</span></label>
      <label class="ef-chk"><input type="checkbox" value="ãƒã‚±ãƒƒãƒˆ" ><span>ãƒã‚±ãƒƒãƒˆ</span></label>
      <label class="ef-chk"><input type="checkbox" value="20MAãƒªãƒ" ><span>20MAãƒªãƒ</span></label>
      <label class="ef-chk"><input type="checkbox" value="200MAãƒªã‚¯ãƒ¬ã‚¤ãƒ " ><span>200MAãƒªã‚¯ãƒ¬ã‚¤ãƒ </span></label>
    </div>

    <label>ä¸Šæ˜‡ç‡â‰¥ <input type="number" id="th_rate" placeholder="3.0" step="0.1" inputmode="decimal" autocomplete="off"></label>
    <label>å£²è²·ä»£é‡‘â‰¥ <input type="number" id="th_turn" placeholder="10" step="0.1" inputmode="decimal" autocomplete="off"></label>
    <label>RVOLä»£é‡‘â‰¥ <input type="number" id="th_rvol" placeholder="3.0" step="0.1" inputmode="decimal" autocomplete="off"></label>

    <!-- â–¼ é€²æ—ç‡ / ã‚¹ã‚³ã‚¢ï¼ˆæœ€å°å€¤ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ -->
    <label>é€²æ—ç‡â‰¥ <input type="number" id="th_progress" placeholder="80" step="1" inputmode="decimal" autocomplete="off"></label>
    <label>ã‚¹ã‚³ã‚¢â‰¥ <input type="number" id="th_score" placeholder="0" step="1" inputmode="decimal" autocomplete="off"></label>
    <!-- â–² ã“ã“ã¾ã§ -->

    <label><input type="checkbox" id="f_defaultset"> è¦å®š</label>



    <input type="text" id="q" placeholder="å…¨æ–‡æ¤œç´¢ï¼ˆã‚³ãƒ¼ãƒ‰/éŠ˜æŸ„/åˆ¤å®šç†ç”±ãªã©ï¼‰" style="min-width:240px">
    <button class="btn" id="btn-stats">å‚¾å‘ã‚°ãƒ©ãƒ•</button>
    <button class="btn" id="btn-ts">æ¨ç§»ã‚°ãƒ©ãƒ•</button>

    <span class="pager">
      <label>è¡¨ç¤ºä»¶æ•°
        <select id="perpage">
          <option value="200">200</option><option value="500">500</option>
          <option value="1000">1000</option><option value="2000" selected>2000</option>
        </select>
      </label>
      <button class="btn" id="prev">å‰ã¸</button>
      <button class="btn" id="next">æ¬¡ã¸</button>
      <span id="pageinfo" class="muted">- / -</span>
    </span>
    <span class="count">ä»¶æ•°: <b id="count">-</b></span>
  </div>


<script id="__DATA__" type="application/json">{{ data_json|safe }}</script>

<script>
(function(){
  "use strict";

  // ---- data ----
  const RAW = (()=>{ try{ return JSON.parse(document.getElementById("__DATA__").textContent||"{}"); }catch(_){ return {}; } })();
  const DATA_CAND = Array.isArray(RAW.cand)? RAW.cand: [];
  const DATA_ALL  = Array.isArray(RAW.all) ? RAW.all : [];
  const DATA_LOG  = Array.isArray(RAW.logs)? RAW.logs: [];
  const DATA_EARN = Array.isArray(RAW.earnings) ? RAW.earnings : [];
  const _preSrc = RAW.preearn ?? RAW.pre ?? RAW.pre_rows ?? RAW.preearn_rows ?? RAW["pre-earnings"] ?? RAW.earnings_pre ?? [];
  const DATA_PREEARN = Array.isArray(_preSrc) ? _preSrc : [];

  // ---- utils ----
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const num = (v)=>{ const s=String(v??"").replace(/[,\så††ï¼…%]/g,""); const n=parseFloat(s); return Number.isFinite(n)?n:NaN; };
  const cmp = (a,b)=>{ if(a==null&&b==null) return 0; if(a==null) return -1; if(b==null) return 1;
    const na=+a, nb=+b, da=new Date(a), db=new Date(b);
    if(!Number.isNaN(na)&&!Number.isNaN(nb)) return na-nb;
    if(!Number.isNaN(da)&&!Number.isNaN(db)) return da-db;
    return String(a).localeCompare(String(b),"ja"); };
  const hasKouho = (v)=> String(v||"").includes("å€™è£œ");

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  // copy link
  function codeLink(code){
    if(code==null) return "";
    const s = String(code).padStart(4, "0");
    return `<a href="#" class="copylink" data-copy="${s}" title="ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼">${s}</a>`;
  }
  document.addEventListener("click", async (e)=>{
    const a = e.target.closest && e.target.closest("a.copylink");
    if (!a) return;
    e.preventDefault();
    const text = a.dataset.copy || "";
    try{
      if (navigator.clipboard && window.isSecureContext !== false) {
        await navigator.clipboard.writeText(text);
      } else {
        const ta = document.createElement("textarea");
        ta.value = text; ta.style.position = "fixed"; ta.style.left = "-9999px";
        document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
      }
      const old = a.textContent; a.classList.add("ok"); a.textContent = "ã‚³ãƒ”ãƒ¼æ¸ˆ";
      setTimeout(() => { a.classList.remove("ok"); a.textContent = old; }, 1200);
    } catch (_){
      const old = a.textContent; a.textContent = "å¤±æ•—"; setTimeout(() => { a.textContent = old; }, 1200);
    }
  });

  // offerings badge
  const OFFER_SET = new Set((Array.isArray(RAW.offer_codes) ? RAW.offer_codes : []).map(x => String(x).padStart(4,"0")));
  function offeringBadge(code){
    const c = String(code ?? "").padStart(4,"0");
    return OFFER_SET.has(c) ? `<span class="badge b-gray" title="ç›´è¿‘ã«å¢—è³‡/è¡Œä½¿/å£²å‡º/CBãªã©ã®å±¥æ­´ã‚ã‚Š">å¢—è³‡çµŒæ­´</span>` : "";
  }

  // finance modal
  function openFinanceHtml(code){
    closeAllTips();
    const back = ensureChartModal();
    const body = document.getElementById("__chart_body__");
    const src = `graph/finance_${String(code).padStart(4,"0")}.html`;
    body.innerHTML = `<iframe src="${src}" style="width:100%; height:80vh; border:0;"></iframe>`;
    back.style.display = "block";
    const box = document.querySelector(".help-pop");
    box.style.display = "block";
    const sx = window.scrollX||0, sy = window.scrollY||0;
    box.style.top = `${sy+60}px`;
    requestAnimationFrame(()=>{ box.style.left = `${sx + Math.max(10, (document.documentElement.clientWidth - box.offsetWidth)/2)}px`; });
  }
  function financeLink(code){
    if(code==null) return "";
    const s = String(code).padStart(4, "0");
    return `<a href="#" class="financelink" data-code="${s}" title="è²¡å‹™ã‚°ãƒ©ãƒ•ã‚’é–‹ã">è²¡å‹™</a>`;
  }
  function financeNote(row){
    let v = row?.["è²¡å‹™ã‚³ãƒ¡ãƒ³ãƒˆ"];
    if (!v) return "";
    let s = String(v).trim();
    // å…ˆé ­ã®ã€Œâš ã€ã€Œåˆ¤å®šï¼ˆâ€¦ï¼‰:ã€ã€Œåˆ¤å®š:ã€ã€Œã‚³ãƒ¡ãƒ³ãƒˆ:ã€ãªã©ã‚’é™¤å»
    s = s
      .replace(/^\s*[âš ï¸âš ï¸â–³â–²â€»ï¼Š*]?\s*åˆ¤å®šï¼ˆ[^ï¼‰]*ï¼‰\s*[:ï¼š]?\s*/i, "")
      .replace(/^\s*[âš ï¸âš ï¸â–³â–²â€»ï¼Š*]?\s*(åˆ¤å®š|ã‚³ãƒ¡ãƒ³ãƒˆ)\s*[:ï¼š]?\s*/i, "")
      .replace(/^\s*[ï¼š:\-ãƒ»]+\s*/, ""); // ä½™åˆ†ãªåŒºåˆ‡ã‚ŠãŒç¶šãå ´åˆã®æƒé™¤
    const t = escapeHtml(s);
    return ` <span class="fn-note" title="${t}">${t}</span>`;
  }
  document.addEventListener("click", (e)=>{
    const a = e.target.closest && e.target.closest("a.financelink");
    if(!a) return;
    e.preventDefault();
    const code = a.dataset.code;
    if(code) openFinanceHtml(code);
  });

  // DOM sort (generic)
  function wireDomSort(tableSelector){
    const table = document.querySelector(tableSelector); if(!table) return;
    const ths = Array.from(table.querySelectorAll('thead th.sortable'));
    const cellVal = (td)=>{
      if (!td) return '';
      const ds = td.getAttribute ? td.getAttribute('data-sort') : null;
      return (ds !== null && ds !== '') ? ds : (td.textContent || '');
    };
    const toNum = (s)=>{
      let t = String(s ?? '').trim().replace(/\s|[å††ï¼…%]/g,'');
      if (t.indexOf('.') === -1 && /^-?\d+,\d+$/.test(t)) t = t.replace(',', '.'); else t = t.replace(/,/g,'');
      const n = parseFloat(t);
      return Number.isFinite(n) ? n : NaN;
    };
    ths.forEach((th)=>{
      if (th.__wiredSort) return;
      th.__wiredSort = true;
      th.style.cursor = 'pointer';
      th.addEventListener('click', ()=>{
        const colIndex = th.cellIndex;
        const dirPrev = th.dataset.dir;
        ths.forEach(h=>{ h.dataset.dir=''; const a=h.querySelector('.arrow'); if(a) a.textContent=''; });
        const dir = (dirPrev === 'asc') ? 'desc' : 'asc';
        th.dataset.dir = dir;
        const typ = th.dataset.type || 'text';
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        rows.sort((r1, r2)=>{
          const aRaw = cellVal(r1.children[colIndex]).trim();
          const bRaw = cellVal(r2.children[colIndex]).trim();
          if (typ === 'num'){
            const aKey = toNum(aRaw), bKey = toNum(bRaw);
            if (!Number.isNaN(aKey) && !Number.isNaN(bKey)){
              return dir==='asc' ? (aKey-bKey) : (bKey-aKey);
            }
          } else if (typ === 'date'){
            const aKey = Date.parse(aRaw), bKey = Date.parse(bRaw);
            if (!Number.isNaN(aKey) && !Number.isNaN(bKey)){
              return dir==='asc' ? (aKey-bKey) : (bKey-aKey);
            }
          }
          const sa = String(aRaw).toLowerCase();
          const sb = String(bRaw).toLowerCase();
          return dir==='asc' ? sa.localeCompare(sb,'ja') : sb.localeCompare(sa,'ja');
        });
        const tb = table.querySelector('tbody');
        rows.forEach(r=>tb.appendChild(r));
        const arrow = th.querySelector('.arrow'); if (arrow) arrow.textContent = (dir==='asc'?'â–²':'â–¼');
      });
    });
  }

  // state
  const state = { tab:"cand", page:1, per:parseInt($("#perpage")?.value||"500",10), sortKey:null, sortDir:1, q:"", data: DATA_CAND.slice() };
  window.state = state;

  const DEFAULTS = { rate:3, turn:5, rvol:2 };
  function applyDefaults(on){
    const ia=$("#th_rate"), it=$("#th_turn"), ir=$("#th_rvol");
    if(!ia||!it||!ir) return;
    if(on){ ia.value=DEFAULTS.rate; it.value=DEFAULTS.turn; ir.value=DEFAULTS.rvol; }
    else  { ia.value=""; it.value=""; ir.value=""; ia.removeAttribute("value"); it.removeAttribute("value"); ir.removeAttribute("value"); }
    state.page=1; render();
  }
  function forceClearThresholds(){
    const cb=$("#f_defaultset");
    if(cb) cb.checked=false;
    applyDefaults(false);
  }
  function thRate(){ const v=num($("#th_rate")?.value); return Number.isNaN(v)?null:v; }
  function thTurn(){ const v=num($("#th_turn")?.value); return Number.isNaN(v)?null:v; }
  function thRvol(){ const v=num($("#th_rvol")?.value); return Number.isNaN(v)?null:v; }
  function thProg(){ const v=num($("#th_progress")?.value); return Number.isNaN(v)?null:v; }
  function thScore(){ const v=num($("#th_score")?.value); return Number.isNaN(v)?null:v; }  // â˜…è¿½åŠ 

  function getSelectedTypes(){
    const box = document.querySelector(".early-filter");
    if (!box) return [];
    return Array.from(box.querySelectorAll(".ef-chk input:checked")).map(el => el.value);
  }

  function isHitRow(r){
    const v = String((r && (r["åˆ¤å®š"] ?? r["judge"] ?? "")) || "").trim().toLowerCase();
    if (/^å½“ãŸã‚Š/.test(v)) return true;
    if (v === "win" || v === "auto" || v === "å†è©•ä¾¡ok") return true;
    return false;
  }

  function applyFilter(rows){
    const q   = ($("#q")?.value||"").trim();
    const sel = getSelectedTypes();
    const useEarly = sel.length > 0;
    return rows.filter(r=>{
      const sh  = hasKouho(r["åˆå‹•ãƒ•ãƒ©ã‚°"]);
      const te  = hasKouho(r["åº•æ‰“ã¡ãƒ•ãƒ©ã‚°"]);
      const ru  = hasKouho(r["å³è‚©ä¸ŠãŒã‚Šãƒ•ãƒ©ã‚°"]);
      const ea  = hasKouho(r["å³è‚©æ—©æœŸãƒ•ãƒ©ã‚°"]);
      const etp = (String(r["å³è‚©æ—©æœŸç¨®åˆ¥"]||"").trim().length>0);
      const ns  = String(r["ç©ºå£²ã‚Šæ©Ÿé–¢ãªã—_flag"]||"0")==="1";
      const op  = String(r["å–¶åˆ©å¯¾æ™‚ä¾¡_flag"]||"0")==="1";
      const hit = isHitRow(r);

      // æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›/å°å£ææ¡ˆï¼‰ãƒ•ã‚£ãƒ«ã‚¿
      const rec = (String(r["æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"]||"").trim());
      const recStrong = (rec === "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›");
      const recSmall  = (rec === "å°å£ææ¡ˆ");

      if($("#f_shodou")?.checked && !sh) return false;
      if($("#f_tei")?.checked    && !te) return false;
      if($("#f_both")?.checked   && !(sh && ru)) return false;
      if($("#f_rightup")?.checked&& !ru) return false;
      if($("#f_early")?.checked  && !ea) return false;
      if($("#f_etype")?.checked  && !etp) return false;
      if($("#f_recstrong")?.checked && !recStrong) return false; // â˜…è¿½åŠ 
      if($("#f_smallpos")?.checked  && !recSmall)  return false; // â˜…è¿½åŠ 
      if($("#f_noshor")?.checked && !ns) return false;
      if($("#f_opratio")?.checked&& !op) return false;
      if($("#f_hit")?.checked    && !hit) return false;

      if (useEarly){
        const val = String(r["å³è‚©æ—©æœŸç¨®åˆ¥"]||"");
        if (!sel.some(v => val.includes(v))) return false;
      }

      const rate  = num(r["å‰æ—¥çµ‚å€¤æ¯”ç‡"]);
      const turn  = num(r["å£²è²·ä»£é‡‘(å„„)"]);
      const rvol  = num(r["RVOLä»£é‡‘"]);
      const prog  = num(r["é€²æ—ç‡"]);   // ï¼…æƒ³å®š
      const score = num(r["ã‚¹ã‚³ã‚¢"]);   // â˜…è¿½åŠ 

      const tr = thRate(), tt = thTurn(), tv = thRvol(), tp = thProg(), ts = thScore(); // â˜…tsè¿½åŠ 

      if(tr!=null && !(rate>=tr)) return false;
      if(tt!=null && !(turn>=tt)) return false;
      if(tv!=null && !(rvol>=tv)) return false;
      if(tp!=null && !(prog>=tp)) return false;     // é€²æ—ç‡
      if(ts!=null && !(score>=ts)) return false;    // â˜…ã‚¹ã‚³ã‚¢

      if(q){
        const keys=["ã‚³ãƒ¼ãƒ‰","éŠ˜æŸ„å","åˆ¤å®šç†ç”±","å³è‚©æ—©æœŸç¨®åˆ¥","åˆå‹•ãƒ•ãƒ©ã‚°","åº•æ‰“ã¡ãƒ•ãƒ©ã‚°","å³è‚©ä¸ŠãŒã‚Šãƒ•ãƒ©ã‚°","å³è‚©æ—©æœŸãƒ•ãƒ©ã‚°","æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"];
        if(!keys.some(k=>String(r[k]??"").includes(q))) return false;
      }
      return true;
    });
  }

  function sortRows(rows){
    return state.sortKey ? rows.slice().sort((a,b)=> state.sortDir * cmp(a[state.sortKey], b[state.sortKey])) : rows;
  }

  function formatJudgeLabel(r){
    return isHitRow(r) ? "å½“ãŸã‚Šï¼(1)" : "å¤–ã‚Œï¼(1)";
  }

  // render: candidate
  function renderCand(){
    const body = document.querySelector("#tbl-candidate tbody");
    if(!body) return;
    const rows = sortRows(applyFilter(state.data));
    const total = rows.length, per = state.per, maxPage = Math.max(1, Math.ceil(total/per));
    state.page = Math.min(state.page, maxPage);
    const s = (state.page-1)*per, e = Math.min(s+per, total);

    let html = "";
    for (let i = s; i < e; i++) {
      const r = rows[i] || {};
      const et = (r["å³è‚©æ—©æœŸç¨®åˆ¥"] || "").trim();
      let etBadge = et;
      if (et === "ãƒ–ãƒ¬ã‚¤ã‚¯") etBadge = '<span class="badge b-green">â— ãƒ–ãƒ¬ã‚¤ã‚¯</span>';
      else if (et === "20MAãƒªãƒ") etBadge = '<span class="badge b-green">â— 20MAãƒªãƒ</span>';
      else if (et === "ãƒã‚±ãƒƒãƒˆ") etBadge = '<span class="badge b-orange">â— ãƒã‚±ãƒƒãƒˆ</span>';
      else if (et === "200MAãƒªã‚¯ãƒ¬ã‚¤ãƒ ") etBadge = '<span class="badge b-yellow">â— 200MAãƒªã‚¯ãƒ¬ã‚¤ãƒ </span>';

      const rec = (r["æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"] || "").trim();
      let recBadge = "";
      if (rec === "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›")      recBadge = '<span class="rec-badge rec-strong" title="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›"><span class="rec-dot"></span>æœ‰åŠ›</span>';
      else if (rec === "å°å£ææ¡ˆ")        recBadge = '<span class="rec-badge rec-small" title="å°å£ææ¡ˆ"><span class="rec-dot"></span>å°å£</span>';
      else if (rec)                       recBadge = `<span class="rec-badge rec-watch" title="${rec.replace(/"/g,'&quot;')}"><span class="rec-dot"></span>${rec}</span>`;

      const isHitTr = isHitRow(r);
      html += `<tr${isHitTr ? " class='hit'" : ""}>
        <td>${codeLink(r["ã‚³ãƒ¼ãƒ‰"])} ${offeringBadge(r["ã‚³ãƒ¼ãƒ‰"])}</td>
        <td>${r["éŠ˜æŸ„å"] ?? ""}</td>
        <td>${r["å¸‚å ´"] || "-"}</td>
        <td><a href="${r["yahoo_url"] ?? "#"}" target="_blank" rel="noopener">Yahoo</a></td>
        <td><a href="${r["x_url"] ?? "#"}" target="_blank" rel="noopener">Xæ¤œç´¢</a></td>
        <td class="num">${r["ç¾åœ¨å€¤"] ?? ""}</td>
        <td class="num">${r["å‰æ—¥çµ‚å€¤"] ?? ""}</td>
        <td class="num">${r["å‰æ—¥å††å·®"] ?? ""}</td>
        <td class="num">${r["å‰æ—¥çµ‚å€¤æ¯”ç‡"] ?? ""}</td>
        <td class="num">${r["å‡ºæ¥é«˜"] ?? ""}</td>
        <td class="num">${r["å£²è²·ä»£é‡‘(å„„)"] ?? ""}</td>
        <td>${financeLink(r["ã‚³ãƒ¼ãƒ‰"])}${financeNote(r)}</td>
        <td>${escapeHtml(r["overall_alpha"] ?? "")}</td>
        <td class="num">${r["ã‚¹ã‚³ã‚¢"] ?? ""}</td>
        <td class="num">${r["é€²æ—ç‡"] ?? ""}</td>
        <td>${r["å¢—è³‡ãƒªã‚¹ã‚¯"] ?? ""}</td>
        <td class="num">${r["å¢—è³‡ã‚¹ã‚³ã‚¢"] ?? ""}</td>
        <td class="reason-col">${r["å¢—è³‡ç†ç”±"] || ""}</td>
        <td>${r["åˆå‹•ãƒ•ãƒ©ã‚°"] || ""}</td>
        <td>${r["åº•æ‰“ã¡ãƒ•ãƒ©ã‚°"] || ""}</td>
        <td>${r["å³è‚©ä¸ŠãŒã‚Šãƒ•ãƒ©ã‚°"] || ""}</td>
        <td>${r["å³è‚©æ—©æœŸãƒ•ãƒ©ã‚°"] || ""}</td>
        <td class="num">${r["å³è‚©æ—©æœŸã‚¹ã‚³ã‚¢"] ?? ""}</td>
        <td>${etBadge}${r["å³è‚©æ—©æœŸç¨®åˆ¥_mini"] || ""}</td>
        <td>${formatJudgeLabel(r)}</td>
        <td class="reason-col">${r["åˆ¤å®šç†ç”±"] || ""}</td>
        <td>${recBadge}</td>
        <td class="num">${r["æ¨å¥¨æ¯”ç‡"] ?? ""}</td>
        <td>${r["ã‚·ã‚°ãƒŠãƒ«æ›´æ–°æ—¥"] || ""}</td>
      </tr>`;
    }
    body.innerHTML = html;
    document.querySelector("#count").textContent = String(total);
    document.querySelector("#pageinfo").textContent = `${state.page} / ${Math.max(1, Math.ceil(total/state.per))}`;
    wireDomSort("#tbl-candidate");
  }

  // === Tomorrow logic START =====================================

  // æ­£è¦åŒ–: ä»»æ„ã® Date / æ–‡å­—åˆ— â†’ YYYY-MM-DD
  function toKey(x){
    if (x instanceof Date) {
      const y=x.getFullYear(), m=('0'+(x.getMonth()+1)).slice(-2), d=('0'+x.getDate()).slice(-2);
      return `${y}-${m}-${d}`;
    }
    const s = String(x ?? "").trim().slice(0,10).replace(/[./]/g,'-').replace(/\//g,'-');
    const m = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (m) return `${m[1]}-${m[2].padStart(2,'0')}-${m[3].padStart(2,'0')}`;
    const dt = new Date(s);
    if (isNaN(+dt)) return "";
    const yy=dt.getFullYear(), mm=('0'+(dt.getMonth()+1)).slice(-2), dd=('0'+dt.getDate()).slice(-2);
    return `${yy}-${mm}-${dd}`;
  }

  function latestUpdateDate(rows){
    const ds = (rows||[]).map(r=>toKey(r?.["ã‚·ã‚°ãƒŠãƒ«æ›´æ–°æ—¥"])).filter(Boolean);
    return ds.sort().pop() || null;
  }

  function localDateStr(d){
    const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), da=('0'+d.getDate()).slice(-2);
    return `${y}-${m}-${da}`;
  }
  function prevBusinessDay(d){
    const dt=new Date(d); do{ dt.setDate(dt.getDate()-1);}while([0,6].includes(dt.getDay())); return dt;
  }
  function nextBusinessDay(d){
    const dt=new Date(d); do{ dt.setDate(dt.getDate()+1);}while([0,6].includes(dt.getDay())); return dt;
  }

  // ã€Œå€™è£œã€åˆ¤å®šï¼ˆåˆå‹•/å³è‚©/æ—©æœŸã®ã„ãšã‚Œã‹ï¼‰
  function _hasCandidateFlag(r){
    return String(r?.["åˆå‹•ãƒ•ãƒ©ã‚°"]||"").includes("å€™è£œ")
        || String(r?.["å³è‚©ä¸ŠãŒã‚Šãƒ•ãƒ©ã‚°"]||"").includes("å€™è£œ")
        || String(r?.["å³è‚©æ—©æœŸãƒ•ãƒ©ã‚°"]||"").includes("å€™è£œ");
  }

  // åŸºæº–æ—¥ã‚­ãƒ¼ã«å¯¾ã—ã¦ã€Œå€™è£œã€ã ã‘ã‚’æŠ½å‡º
  function _pickTomorrowRows(src, baseKey){
    if(!Array.isArray(src) || !baseKey) return [];
    return src.filter(r => toKey(r?.["ã‚·ã‚°ãƒŠãƒ«æ›´æ–°æ—¥"])===baseKey && _hasCandidateFlag(r));
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚è¨ˆã‹ã‚‰åŸºæº–æ—¥/å¯¾è±¡æ—¥ã‚’è¨ˆç®—ï¼ˆ14:30 å‡çµãƒ«ãƒ¼ãƒ«ï¼‰
  function _computeBaseAndTargetFromLocalNow(){
    const now = new Date();
    const inFreeze = (now.getHours() < 14) || (now.getHours() === 14 && now.getMinutes() < 30);
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const baseDate = inFreeze ? prevBusinessDay(today) : today;
    const targetDate = nextBusinessDay(baseDate);
    return { inFreeze, baseDate, targetDate };
  }

  function renderTomorrow(rows){
    const body = document.querySelector("#tbl-tmr tbody");
    if (!body) return;
    let html = "";
    rows.forEach(r=>{
      const rec = (r["æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"] || "").trim();
      let recBadge = "";
      if (rec === "ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›") recBadge = '<span class="rec-badge rec-strong" title="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›"><span class="rec-dot"></span>æœ‰åŠ›</span>';
      else if (rec === "å°å£ææ¡ˆ")   recBadge = '<span class="rec-badge rec-small" title="å°å£ææ¡ˆ"><span class="rec-dot"></span>å°å£</span>';
      else if (rec)                  recBadge = `<span class="rec-badge rec-watch" title="${rec.replace(/"/g,'&quot;')}"><span class="rec-dot"></span>${rec}</span>`;
      const isHit = isHitRow(r);
      html += `<tr${isHit ? " class='hit'" : ""}>
        <td>${codeLink(r["ã‚³ãƒ¼ãƒ‰"])} ${offeringBadge(r["ã‚³ãƒ¼ãƒ‰"])}</td>
        <td>${r["éŠ˜æŸ„å"] ?? ""}</td>
        <td>${r["å¸‚å ´"] || "-"}</td>
        <td><a href="${r["yahoo_url"]??"#"}" target="_blank" rel="noopener">Yahoo</a></td>
        <td><a href="${r["x_url"]??"#"}" target="_blank" rel="noopener">Xæ¤œç´¢</a></td>
        <td class="num" data-sort="${r['ç¾åœ¨å€¤_raw'] ?? ''}">${r['ç¾åœ¨å€¤'] ?? ''}</td>
        <td class="num" data-sort="${r['å‰æ—¥çµ‚å€¤æ¯”ç‡_raw'] ?? ''}">${r['å‰æ—¥çµ‚å€¤æ¯”ç‡'] ?? ''}</td>
        <td class="num">${r["å£²è²·ä»£é‡‘(å„„)"]??""}</td>
        <td>${financeLink(r["ã‚³ãƒ¼ãƒ‰"])}${financeNote(r)}</td>
        <td>${r["å¢—è³‡ãƒªã‚¹ã‚¯"] ?? ""}</td>
        <td class="num">${r["å¢—è³‡ã‚¹ã‚³ã‚¢"] ?? ""}</td>
        <td class="reason-col">${r["å¢—è³‡ç†ç”±"] || ""}</td>
        <td class="num">${r["å³è‚©æ—©æœŸã‚¹ã‚³ã‚¢"]??""}</td>
        <td>${(r["å³è‚©æ—©æœŸç¨®åˆ¥"]||"").trim()}</td>
        <td>${isHit ? "å½“ãŸã‚Šï¼(1)" : "å¤–ã‚Œï¼(1)"}</td>
        <td>${recBadge}</td>
      </tr>`;
    });
    body.innerHTML = html;
    wireDomSort("#tbl-tmr");
  }

  // ä¸¦ã³æ›¿ãˆï¼ˆæ¨å¥¨ > å³è‚©æ—©æœŸS > å£²è²·ä»£é‡‘ï¼‰
  function _sortTomorrow(rows){
    return rows.slice().sort((a,b)=>{
      const rank = (x)=> x==="ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›" ? 2 : (x==="å°å£ææ¡ˆ" ? 1 : 0);
      const r = rank((b["æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"]||"").trim()) - rank((a["æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"]||"").trim());
      if (r !== 0) return r;
      const s = (+b["å³è‚©æ—©æœŸã‚¹ã‚³ã‚¢"]||0) - (+a["å³è‚©æ—©æœŸã‚¹ã‚³ã‚¢"]||0);
      if (s !== 0) return s;
      return (+b["å£²è²·ä»£é‡‘(å„„)"]||0) - (+a["å£²è²·ä»£é‡‘(å„„)"]||0);
    });
  }

  function renderTomorrowWrapper(){
    // 1) åŸºæº–æ—¥/å¯¾è±¡æ—¥ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚è¨ˆ & 14:30 å‡çµï¼‰
    const { inFreeze, baseDate, targetDate } = _computeBaseAndTargetFromLocalNow();
    const baseKey = toKey(baseDate);
    const targetKey = toKey(targetDate);

    // 2) ãƒ‡ãƒ¼ã‚¿å´ã®æœ€æ–°æ›´æ–°æ—¥ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
    const latestKey = latestUpdateDate(DATA_CAND);

    // 3) æŠ½å‡ºï¼ˆã‚¼ãƒ­å›é¿ã®å¤šæ®µãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    let reason = `åŸºæº–æ—¥ã®ã€Œå€™è£œã€`;
    let rows = _pickTomorrowRows(DATA_CAND, baseKey);

    if (rows.length === 0 && latestKey && latestKey !== baseKey){
      rows = _pickTomorrowRows(DATA_CAND, latestKey);
      if (rows.length) reason = `æœ€æ–°æ—¥(${latestKey})ã®ã€Œå€™è£œã€ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯`;
    }
    if (rows.length === 0){
      rows = (DATA_CAND||[]).filter(r => toKey(r?.["ã‚·ã‚°ãƒŠãƒ«æ›´æ–°æ—¥"])===baseKey);
      if (rows.length) reason = `åŸºæº–æ—¥(${baseKey})ã®å…¨ä»¶ï¼ˆå€™è£œæ¡ä»¶ãªã—ï¼‰`;
    }
    if (rows.length === 0 && latestKey){
      rows = (DATA_CAND||[]).filter(r => toKey(r?.["ã‚·ã‚°ãƒŠãƒ«æ›´æ–°æ—¥"])===latestKey);
      if (rows.length) reason = `æœ€æ–°æ—¥(${latestKey})ã®å…¨ä»¶ï¼ˆå€™è£œæ¡ä»¶ãªã—ï¼‰`;
    }
    if (rows.length === 0){
      rows = (DATA_CAND||[]).slice();
      reason = `å…¨ä½“ã‹ã‚‰ã®ã‚µãƒ³ãƒ—ãƒ«`;
    }

    // ä¸¦ã³æ›¿ãˆ & ä¸Šé™ï¼ˆè¦‹ã‚„ã™ã•ç”¨ã«æœ€å¤§2000ã¯ãã®ã¾ã¾ï¼‰
    rows = _sortTomorrow(rows);

    // 4) ãƒ©ãƒ™ãƒ«æ›´æ–°ï¼ˆåŸºæº–æ—¥ãƒ»å¯¾è±¡æ—¥ãƒ»å‡çµçŠ¶æ…‹ãƒ»æŠ½å‡ºæ ¹æ‹ ï¼‰
    const lbl = document.getElementById("tmr-label");
    if (lbl){
      const baseStr = localDateStr(baseDate);
      const tgtStr  = localDateStr(targetDate);
      const freezeStr = inFreeze ? "ON" : "OFF";
      lbl.textContent = `ğŸ“… ${tgtStr} å‘ã‘ï¼ˆåŸºæº–æ—¥: ${baseStr} / å‡çµ: ${freezeStr} / æŠ½å‡º: ${rows.length}ä»¶ãƒ»${reason}ï¼‰`;
    }

    // 5) æç”»
    window.DATA_TMR = rows;
    renderTomorrow(rows);
  }

  // === Tomorrow logic END =====================================

  // all
  function renderAll(){
    const head = document.querySelector("#all-head"), body = document.querySelector("#all-body");
    if(!head||!body) return;
    head.innerHTML=body.innerHTML="";
    const rows=DATA_ALL;
    if(!rows.length) return;
    const cols=Object.keys(rows[0]);
    head.innerHTML=cols.map(c=>{
      const typ=(c.includes("ãƒ•ãƒ©ã‚°")?"flag":(c.includes("æ—¥")||c.includes("æ›´æ–°")||c==="æ—¥æ™‚"?"date":(["ç¾åœ¨å€¤","å‡ºæ¥é«˜","å£²è²·ä»£é‡‘(å„„)","æ™‚ä¾¡ç·é¡å„„å††","å³è‚©æ—©æœŸã‚¹ã‚³ã‚¢","æ¨å¥¨æ¯”ç‡","å‰æ—¥çµ‚å€¤æ¯”ç‡","å‰æ—¥çµ‚å€¤æ¯”ç‡ï¼ˆï¼…ï¼‰"].includes(c)?"num":"text")));
      return `<th class="sortable ${typ==='num'?'num':''}" data-col="${c}" data-type="${typ}">${c}<span class="arrow"></span></th>`;
    }).join("");
    body.innerHTML=rows.slice(0,2000).map(r=>`<tr>${
      cols.map(c=>{
        let v = (c === "åˆ¤å®š") ? formatJudgeLabel(r) : (r[c] ?? "");
        if (c === "ã‚³ãƒ¼ãƒ‰") v = codeLink(v);
        const isNum = ['ç¾åœ¨å€¤','å‡ºæ¥é«˜','å£²è²·ä»£é‡‘(å„„)','æ™‚ä¾¡ç·é¡å„„å††','å³è‚©æ—©æœŸã‚¹ã‚³ã‚¢','æ¨å¥¨æ¯”ç‡','å‰æ—¥çµ‚å€¤æ¯”ç‡','å‰æ—¥çµ‚å€¤æ¯”ç‡ï¼ˆï¼…ï¼‰'].includes(c);
        return `<td class="${isNum?'num':''}">${v}</td>`;
      }).join("")
    }</tr>`).join("");
    wireDomSort("#tbl-allcols");
  }
  
  // --- ã“ã“ã‹ã‚‰è¿½åŠ  ---
  // ã‚¿ãƒ–å…±é€šãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ï¼ˆãƒ•ã‚£ãƒ«ã‚¿/ãƒšãƒ¼ã‚¸ãƒ£/åˆæœŸåŒ–ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
  function render(){
    if (state.tab === "all") { renderAll(); return; }
    if (state.tab === "tmr") { renderTomorrowWrapper(); return; }
    // æ—¢å®šã¯å€™è£œä¸€è¦§
    renderCand();
  }
  // --- ã“ã“ã¾ã§è¿½åŠ  ---

  // earn
  function fmtTime(ts){
    try{
      const d = new Date(ts);
      if (!isNaN(d)) {
        const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), da=('0'+d.getDate()).slice(-2);
        const hh=('0'+d.getHours()).slice(-2), mm=('0'+d.getMinutes()).slice(-2);
        return `${y}/${m}/${da} ${hh}:${mm}`;
      }
      return String(ts ?? "");
    }catch(_){ return String(ts ?? ""); }
  }

  function renderEarnings(rows){
    
    // â–¼ éŠ˜æŸ„HTMLã‹ã‚‰ ä¼šç¤¾å / 4æ¡ã‚³ãƒ¼ãƒ‰ ã‚’æŠœããƒ˜ãƒ«ãƒ‘
    function pickNameAndCode(rawName, rawCode){
      const html = String(rawName ?? "");
      // name: ã‚¿ã‚°é™¤å» + æœ«å°¾ã®(dddd)ã‚’æ¶ˆã™
      let name = html.replace(/<[^>]*>/g,"").replace(/\s*\(\d{4}\)\s*$/,"").trim();
      if (!name) name = String(rawName ?? "").trim();
      // code: å„ªå…ˆé † 1) rawCode 2) (dddd) 3) quote/dddd.T
      let code = (rawCode ?? "").toString();
      if (!/^\d{4}$/.test(code)){
        const m1 = html.match(/\((\d{4})\)/);
        if (m1) code = m1[1];
      }
      if (!/^\d{4}$/.test(code)){
        const m2 = html.match(/quote\/(\d{4})\.T/i);
        if (m2) code = m2[1];
      }
      return { name, code: /^\d{4}$/.test(code) ? code : "" };
    }

    const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const yUrl = (c4)=>`https://finance.yahoo.co.jp/quote/${c4}.T`;

    const tbl   = document.getElementById("tbl-earn");
    const thead = tbl?.querySelector("thead tr");
    const tbody = document.getElementById("earn-body");
    if(!tbl||!thead||!tbody){ return; }

    // â–¼ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã€Œã‚³ãƒ¼ãƒ‰ï½œéŠ˜æŸ„ï½œå¸‚å ´ï½œYahooã€+ æ—¢å­˜åˆ—ã«å·®ã—æ›¿ãˆ
    thead.innerHTML = `
      <th>ã‚³ãƒ¼ãƒ‰</th><th>éŠ˜æŸ„</th><th>Yahoo</th>
      <th>ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆ</th><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>è¦ç´„</th>
      <th>åˆ¤å®š</th><th class="reason-col">ç†ç”±</th><th>æ™‚åˆ»</th>
    `;

    if(!rows?.length){
      tbody.innerHTML = `<tr><td colspan="10" class="muted">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>`;
      wireDomSort("#tbl-earn");
      return;
    }

    tbody.innerHTML = rows.map(r=>{
      const rawName = r.name ?? r.symbol ?? r.éŠ˜æŸ„ ?? "";
      const rawCode = r.code ?? r.ticker ?? r.symbol ?? r.ã‚³ãƒ¼ãƒ‰ ?? "";
      const { name, code } = pickNameAndCode(rawName, rawCode);
      const code4   = code ? String(code).padStart(4,"0") : "";
      const market  = r.market ?? r.å¸‚å ´ ?? "";
      const yahoo   = code4 ? `<a href="${yUrl(code4)}" target="_blank" rel="noopener">Yahoo</a>` : "";

      const sRaw = (r.sentiment ?? "").toString().toLowerCase();
      const cls  = sRaw.includes("pos")||sRaw.includes("è‰¯") ? "b-green"
                 : sRaw.includes("neg")||sRaw.includes("æ‚ª") ? "b-orange" : "b-yellow";
      const pill = `<span class="badge ${cls}">â— ${r.sentiment ?? "neutral"}</span>`;

      const title = r.title ? esc(r.title) : "";
      const link  = r.link  ? String(r.link) : "";
      const titleHtml = link ? `<a href="${link}" target="_blank" rel="noopener">${title}</a>` : (title||"-");

      const summary = esc(r.summary ?? "");
      const verdict = esc((r.verdict ?? "").toString());
      const reasons = Array.isArray(r.reasons) ? r.reasons : [];
      const reasonHtml = reasons.length
        ? `<div class="reason-tags">${reasons.slice(0,12).map(x=>`<span class="reason-tag">${esc(String(x))}</span>`).join("")}</div>`
        : `<span class="muted">-</span>`;

      return `<tr>
        <td>${code4 ? codeLink(code4) : ""}</td>
        <td>${esc(name)}</td>
        <td>${yahoo}</td>
        <td>${pill}</td>
        <td>${titleHtml}</td>
        <td class="reason-col">${summary || "<span class='muted'>-</span>"}</td>
        <td>${verdict || "<span class='muted'>-</span>"}</td>
        <td class="reason-col">${reasonHtml}</td>
        <td class="mono">${fmtTime(r.time)}</td>
      </tr>`;
    }).join("");

    wireDomSort("#tbl-earn");
  }

  // pre-earn
  function _fmt2num(x){
    if (x === null || x === undefined) return "";
    const n = parseFloat(String(x).replace(/[,ï¼…%]/g,""));
    if (!Number.isFinite(n)) return String(x ?? "");
    return Number.isInteger(n) ? String(n) : n.toFixed(2);
  }
  function _formatTwoDecimals(tableSelector){
    const tbl = document.querySelector(tableSelector);
    if (!tbl) return;
    const ths = Array.from(tbl.querySelectorAll("thead th"));
    const targets = [];
    const norm = (s)=> String(s||"").replace(/\s+/g,"").replace(/[ï¼ˆï¼‰]/g, v=> (v==="ï¼ˆ"?"(" : ")")).trim();
    ths.forEach((th, idx)=>{
      const t = norm(th.textContent);
      if (t.includes("å‰æ—¥çµ‚å€¤æ¯”ç‡")) targets.push(idx);
      if (t === "å£²è²·ä»£é‡‘(å„„)" || t === "å£²è²·ä»£é‡‘å„„") targets.push(idx);
      if (t === "ç¾åœ¨å€¤" || t === "å‰æ—¥çµ‚å€¤" || t === "å‰æ—¥æ¯”(å††)") targets.push(idx);
    });
    if (!targets.length) return;
    const rows = tbl.querySelectorAll("tbody tr");
    rows.forEach(tr=>{
      targets.forEach(ci=>{
        const td = tr.children[ci]; if (!td) return;
        const raw = td.textContent.trim(); if (!raw) return;
        td.textContent = _fmt2num(raw); td.classList.add("num");
      });
    });
  }

  function renderPreEarnings(rows){
    
    // â–¼ éŠ˜æŸ„HTMLã‹ã‚‰ ä¼šç¤¾å / 4æ¡ã‚³ãƒ¼ãƒ‰ ã‚’æŠœããƒ˜ãƒ«ãƒ‘
    function pickNameAndCode(rawName, rawCode){
      const html = String(rawName ?? "");
      let name = html.replace(/<[^>]*>/g,"").replace(/\s*\(\d{4}\)\s*$/,"").trim();
      if (!name) name = String(rawName ?? "").trim();
      let code = (rawCode ?? "").toString();
      if (!/^\d{4}$/.test(code)){
        const m1 = html.match(/\((\d{4})\)/);
        if (m1) code = m1[1];
      }
      if (!/^\d{4}$/.test(code)){
        const m2 = html.match(/quote\/(\d{4})\.T/i);
        if (m2) code = m2[1];
      }
      return { name, code: /^\d{4}$/.test(code) ? code : "" };
    }

    const esc = (s)=>String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const yUrl = (c4)=>`https://finance.yahoo.co.jp/quote/${c4}.T`;

    const tbl   = document.getElementById("tbl-preearn");
    const thead = tbl?.querySelector("thead tr");
    const tbody = document.getElementById("preearn-body");
    if(!tbl||!thead||!tbody){ return; }

    // â–¼ ãƒ˜ãƒƒãƒ€ãƒ¼å·®ã—æ›¿ãˆ
    thead.innerHTML = `
      <th>ã‚³ãƒ¼ãƒ‰</th><th>éŠ˜æŸ„</th><th>Yahoo</th>
      <th class="num sortable" data-col="pre_score" data-type="num">pre_score<span class="arrow"></span></th>
      <th class="num sortable" data-col="edge_score" data-type="num">edge_score<span class="arrow"></span></th>
      <th class="num sortable" data-col="momentum_score" data-type="num">momentum_score<span class="arrow"></span></th>
      <th class="sortable reason-col" data-col="ã‚¹ã‚³ã‚¢ç†ç”±" data-type="text">ã‚¹ã‚³ã‚¢ç†ç”±<span class="arrow"></span></th>
      <th class="sortable" data-col="äºˆæ¸¬ãƒ’ãƒ³ãƒˆ" data-type="text">äºˆæ¸¬ãƒ’ãƒ³ãƒˆ<span class="arrow"></span></th>
      <th class="num sortable" data-col="æœŸå¾…æ ªä¾¡" data-type="num">æœŸå¾…æ ªä¾¡<span class="arrow"></span></th>
      <th class="sortable" data-col="ä¿®æ­£è¦‹é€šã—" data-type="text">ä¿®æ­£è¦‹é€šã—<span class="arrow"></span></th>
      <th class="sortable" data-col="éç†±åº¦" data-type="text">éç†±åº¦<span class="arrow"></span></th>
    `;

    if(!rows?.length){
      tbody.innerHTML = `<tr><td colspan="12" class="muted">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>`;
      wireDomSort("#tbl-preearn");
      return;
    }

    tbody.innerHTML = rows.map(r=>{
      const rawName = r.name ?? r.symbol ?? r.éŠ˜æŸ„ ?? "";
      const rawCode = r.code ?? r.ticker ?? r.symbol ?? r.ã‚³ãƒ¼ãƒ‰ ?? "";
      const { name, code } = pickNameAndCode(rawName, rawCode);
      const code4   = code ? String(code).padStart(4,"0") : "";
      const market  = r.market ?? r.å¸‚å ´ ?? "";
      const yahoo   = code4 ? `<a href="${yUrl(code4)}" target="_blank" rel="noopener">Yahoo</a>` : "";

      return `<tr>
        <td>${code4 ? codeLink(code4) : ""}</td>
        <td>${escapeHtml(name)}</td>
        <td>${yahoo}</td>
        <td class="num">${_fmt2num(r.pre_score)}</td>
        <td class="num">${_fmt2num(r.edge_score)}</td>
        <td class="num">${_fmt2num(r.momentum_score)}</td>
        <td class="reason-col"><div class="reason-box">${(r["ã‚¹ã‚³ã‚¢ç†ç”±"] ?? "æ ¹æ‹ è–„ã‚ï¼ˆæš«å®šï¼‰")}</div></td>
        <td class="hint-col"><div class="reason-box">${(r["äºˆæ¸¬ãƒ’ãƒ³ãƒˆ"] ?? "ï¼ˆæº–å‚™ä¸­ï¼‰")}</div></td>
        <td class="num">${_fmt2num(r["æœŸå¾…æ ªä¾¡"]) || (_fmt2num(r.ç¾åœ¨å€¤) || "")}</td>
        <td>${r["ä¿®æ­£è¦‹é€šã—"] ?? "ä¸­ç«‹"}</td>
        <td>${r["éç†±åº¦"] ?? "ä¸­ç«‹"}</td>
      </tr>`;
    }).join("");

    wireDomSort("#tbl-preearn");
    _formatTwoDecimals("#tbl-preearn");
  }

  // help & modal
  function ensureHelpDom(){
    let bd=document.querySelector(".help-backdrop");
    if(!bd){ bd=document.createElement("div"); bd.className="help-backdrop"; document.body.appendChild(bd); }
    let pp=document.querySelector(".help-pop");
    if(!pp){ pp=document.createElement("div"); pp.className="help-pop"; pp.innerHTML='<div class="help-head"><div>ãƒ˜ãƒ«ãƒ—</div><div class="help-close">Ã—</div></div><div class="help-body"></div>'; document.body.appendChild(pp); }
    pp.querySelector(".help-close").onclick=()=>{ pp.style.display="none"; bd.style.display="none"; };
    bd.onclick=()=>{ pp.style.display="none"; bd.style.display="none"; };
    return {bd,pp};
  }
  function openHelp(html){
    const {bd,pp}=ensureHelpDom();
    const body = pp.querySelector(".help-body");
    body.innerHTML = html;
    bd.style.display = "block";
    pp.style.display = "block";
    const sy = window.scrollY||0; pp.style.top = `${sy+80}px`;
    requestAnimationFrame(()=>{ pp.style.left = `${Math.max(10,(document.documentElement.clientWidth - pp.offsetWidth)/2)}px`; });
  }
  function closeAllTips(){ const t=document.querySelectorAll('.tooltip, .popover'); t.forEach(el=>el.remove()); }
  function ensureChartModal(){
    let bd=document.getElementById("__chart_back__");
    if(!bd){ bd=document.createElement("div"); bd.id="__chart_back__"; bd.className="help-backdrop"; document.body.appendChild(bd); }
    let pp=document.querySelector("#__chart_box__");
    if(!pp){
      pp=document.createElement("div"); pp.id="__chart_box__"; pp.className="help-pop";
      pp.innerHTML=`<div class="help-head"><div>ã‚°ãƒ©ãƒ•</div><div class="help-close">Ã—</div></div><div id="__chart_body__"></div>`;
      document.body.appendChild(pp);
    }
    pp.querySelector(".help-close").onclick=()=>{ pp.style.display="none"; bd.style.display="none"; };
    bd.onclick=()=>{ pp.style.display="none"; bd.style.display="none"; };
    return bd;
  }

  // charts (simple canvas)
  function drawBar(canvas, labels, values, title){
    const ctx = canvas.getContext("2d"), W = canvas.width, H = canvas.height, pad = 40;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "#000"; ctx.font = "14px system-ui"; ctx.fillText(title, pad, 24);
    ctx.strokeStyle = "#ccc"; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad, H - pad); ctx.lineTo(W - pad, H - pad); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(pad, H - pad); ctx.lineTo(pad, pad); ctx.stroke();
    const nums = values.map(v => (v === "" || v == null ? NaN : +v));
    const finite = nums.filter(Number.isFinite);
    if (!finite.length) { ctx.fillText("ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆæ¬ æï¼‰", pad, H/2); return; }
    const max = Math.max(1, ...finite);
    const bw  = (W - pad*2) / labels.length * 0.7;
    labels.forEach((lb, i) => {
      const v = Number.isFinite(nums[i]) ? nums[i] : 0;
      const x = pad + (i + 0.15) * (W - pad*2) / labels.length;
      const h = (H - pad*2) * (v / max);
      ctx.fillStyle = "#4a90e2";
      if (h > 0) ctx.fillRect(x, H - pad - h, bw, h);
      ctx.fillStyle = "#333"; ctx.font = "12px system-ui";
      ctx.fillText(lb, x, H - pad + 14);
      ctx.fillText(String(v), x, H - pad - h - 4);
    });
  }
  function drawLine(canvas, labels, values, title){
    const ctx = canvas.getContext("2d"), W = canvas.width, H = canvas.height, pad = 40;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = "#000"; ctx.font = "14px system-ui"; ctx.fillText(title, pad, 24);
    ctx.strokeStyle = "#ccc"; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad, H - pad); ctx.lineTo(W - pad, H - pad); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(pad, H - pad); ctx.lineTo(pad, pad); ctx.stroke();
    const nums = values.map(v => (v === "" || v == null ? NaN : +v));
    const finite = nums.filter(Number.isFinite);
    if (!finite.length) { ctx.fillText("ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆæ¬ æï¼‰", pad, H/2); return; }
    const max = Math.max(1, ...finite);
    const min = Math.min(0, ...finite);
    const step = (W - pad*2) / Math.max(1, labels.length - 1);
    ctx.strokeStyle = "#4a90e2"; ctx.lineWidth = 2; ctx.beginPath();
    nums.forEach((v, i) => {
      const val = Number.isFinite(v) ? v : 0;
      const x = pad + i * step;
      const y = H - pad - (H - pad*2) * ((val - min) / (max - min || 1));
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
    if (labels.length === 1) { const x = pad; const val = Number.isFinite(nums[0]) ? nums[0] : 0;
      const y = H - pad - (H - pad*2) * ((val - min) / (max - min || 1));
      ctx.fillStyle = "#4a90e2"; ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill(); }
    ctx.fillStyle = "#333"; ctx.font = "12px system-ui";
    labels.forEach((lb, i) => { const x = pad + i * step; ctx.fillText(lb, x - 10, H - pad + 14); });
  }

  function openStatsChart(){
    const back = ensureChartModal(), body = $("#__chart_body__");
    const rows = applyFilter(state.data);
    const rvolBuckets=["<1","1-2","2-3","3-5","5+"], rvolCnt=[0,0,0,0,0];
    const turnBuckets=["<5","5-10","10-50","50-100","100+"], turnCnt=[0,0,0,0,0];
    rows.forEach(r=>{
      const rvol = num(r["RVOLä»£é‡‘"]);
      if(!Number.isNaN(rvol)){ if(rvol<1)rvolCnt[0]++; else if(rvol<2)rvolCnt[1]++; else if(rvol<3)rvolCnt[2]++; else if(rvol<5)rvolCnt[3]++; else rvolCnt[4]++; }
      const turn = num(r["å£²è²·ä»£é‡‘(å„„)"]);
      if(!Number.isNaN(turn)){ if(turn<5)turnCnt[0]++; else if(turn<10)turnCnt[1]++; else if(turn<50)turnCnt[2]++; else if(turn<100)turnCnt[3]++; else turnCnt[4]++; }
    });
    body.innerHTML = `<h3>å‚¾å‘ã‚°ãƒ©ãƒ•ï¼ˆè¡¨ç¤ºä¸­ãƒ‡ãƒ¼ã‚¿ï¼‰</h3><canvas id="cv1" style="width:100%;height:340px;"></canvas><canvas id="cv2" style="width:100%;height:340px;margin-top:16px;"></canvas>`;
    const c1 = body.querySelector("#cv1"), c2 = body.querySelector("#cv2");
    const fit = ()=>{
      const cssW = body.clientWidth || 900, cssH = 340, dpr = window.devicePixelRatio || 1;
      [c1,c2].forEach(cv=>{
        cv.width = Math.floor(cssW*dpr); cv.height = Math.floor(cssH*dpr);
        cv.style.width = cssW+"px"; cv.style.height = cssH+"px";
        const ctx = cv.getContext("2d"); if (ctx && ctx.setTransform) ctx.setTransform(dpr,0,0,dpr,0,0);
      });
      drawBar(c1, rvolBuckets, rvolCnt, "RVOLä»£é‡‘ã®åˆ†å¸ƒ");
      drawBar(c2, turnBuckets, turnCnt, "å£²è²·ä»£é‡‘(å„„)ã®åˆ†å¸ƒ");
    };
    if (window.__stats_fit__) window.removeEventListener("resize", window.__stats_fit__);
    window.__stats_fit__ = fit;
    window.addEventListener("resize", fit, { passive:true });
    fit();
    back.style.display="block";
    const box = document.querySelector("#__chart_box__"); box.style.display="block";
    const sy = window.scrollY||0; box.style.top = `${sy+80}px`;
    requestAnimationFrame(()=>{ box.style.left = `${Math.max(10,(document.documentElement.clientWidth - box.offsetWidth)/2)}px`; });
  }

  function openTrendChart(){
    const back = ensureChartModal(), body = $("#__chart_body__");
    let src = [];
    try { const RAW = JSON.parse(document.getElementById("__DATA__").textContent || "{}"); if (Array.isArray(RAW.hist) && RAW.hist.length) src = RAW.hist; } catch(_) {}
    if (!src.length) src = applyFilter(state.data);
    const byDay = new Map();
    src.forEach(r=>{
      const d = String(r["ã‚·ã‚°ãƒŠãƒ«æ›´æ–°æ—¥"]||r["æ—¥ä»˜"]||r["æ—¥æ™‚"]||"").slice(0,10);
      if(!d) return;
      const hit = isHitRow(r) ? 1 : 0;
      const o = byDay.get(d) || {tot:0,hit:0};
      o.tot++; o.hit += hit;
      byDay.set(d,o);
    });
    const days = Array.from(byDay.keys()).sort();
    const rate = days.map(d=>{ const o = byDay.get(d)||{tot:0,hit:0}; return o.tot ? Math.round(1000*o.hit/o.tot)/10 : 0; });
    body.innerHTML = `<h3>æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆæ—¥åˆ¥ å½“ãŸã‚Šç‡ %ï¼‰</h3><canvas id="cv3" style="width:100%;height:340px;"></canvas>`;
    const cv = body.querySelector("#cv3");
    const fit = ()=>{
      const cssW = body.clientWidth || 900, cssH = 340, dpr = window.devicePixelRatio || 1;
      cv.width = Math.floor(cssW*dpr); cv.height = Math.floor(cssH*dpr);
      cv.style.width = cssW+"px"; cv.style.height = cssH+"px";
      const ctx = cv.getContext("2d"); if (ctx && ctx.setTransform) ctx.setTransform(dpr,0,0,dpr,0,0);
      drawLine(cv, days, rate, "å½“ãŸã‚Šç‡ï¼ˆ%ï¼‰");
    };
    if (window.__trend_fit__) window.removeEventListener("resize", window.__trend_fit__);
    window.__trend_fit__ = fit;
    window.addEventListener("resize", fit, {passive:true});
    fit();
    back.style.display="block";
    const box = document.querySelector("#__chart_box__"); box.style.display="block";
    const sy = window.scrollY||0; box.style.top = `${sy+80}px`;
    requestAnimationFrame(()=>{ box.style.left = `${Math.max(10,(document.documentElement.clientWidth - box.offsetWidth)/2)}px`; });
  }

  // eventsï¼ˆå„ç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ»å…¥åŠ›ï¼‰
  $("#perpage")?.addEventListener("change",(e)=>{ const v=parseInt(e.target.value,10); state.per=Number.isFinite(v)?v:500; state.page=1; render(); });
  $("#prev")?.addEventListener("click",()=>{ if(state.page>1){state.page--; render();} });
  $("#next")?.addEventListener("click",()=>{ state.page++; render(); });
  $("#q")?.addEventListener("input",(e)=>{ state.q=e.target.value||""; state.page=1; render(); });

  // å˜ä½“IDã§ç®¡ç†ã—ã¦ã„ã‚‹ãƒã‚§ãƒƒã‚¯ãƒ»å…¥åŠ›
  ["th_rate","th_turn","th_rvol","th_progress","th_score",
   "f_shodou","f_tei","f_both","f_rightup","f_early","f_etype",
   "f_recstrong","f_smallpos","f_noshor","f_opratio","f_hit"]
    .forEach(id=>{
      $("#"+id)?.addEventListener("input", ()=>{ state.page=1; render(); });
      $("#"+id)?.addEventListener("change",()=>{ state.page=1; render(); });
    });

  // æ—©æœŸç¨®åˆ¥ï¼ˆãƒ–ãƒ¬ã‚¤ã‚¯/ãƒã‚±ãƒƒãƒˆ/20MAãƒªãƒ/200MAãƒªã‚¯ãƒ¬ã‚¤ãƒ ï¼‰ãƒã‚§ãƒƒã‚¯ã®é…ç·šï¼ˆ.early-filter å†…ï¼‰
  $$(".early-filter .ef-chk input").forEach(el=>{
    el.addEventListener("change", ()=>{ state.page=1; render(); });
  });

  $("#btn-stats")?.addEventListener("click",openStatsChart);
  $("#btn-ts")?.addEventListener("click",openTrendChart);
  $("#f_defaultset")?.addEventListener("change",(e)=>applyDefaults(e.target.checked));

  // ä»»æ„ï¼šãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ï¼ˆå­˜åœ¨ã™ã‚Œã°æœ‰åŠ¹ï¼‰
  $("#btn-help")?.addEventListener("click", ()=>{
    openHelp(`
      <div style="max-width:1000px">
        <p><b>å€™è£œä¸€è¦§ã®ãƒ•ã‚£ãƒ«ã‚¿</b></p>
        <ul>
          <li><b>ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›ã®ã¿</b>â€¦ã€Œæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ãŒ<strong>ã‚¨ãƒ³ãƒˆãƒªãƒ¼æœ‰åŠ›</strong>ã®éŠ˜æŸ„ã‚’æŠ½å‡º</li>
          <li><b>å°å£ææ¡ˆã®ã¿</b>â€¦ã€Œæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€ãŒ<strong>å°å£ææ¡ˆ</strong>ã®éŠ˜æŸ„ã‚’æŠ½å‡º</li>
          <li><b>æ—©æœŸç¨®åˆ¥</b>â€¦ ãƒ–ãƒ¬ã‚¤ã‚¯ / ãƒã‚±ãƒƒãƒˆ / 20MAãƒªãƒ / 200MAãƒªã‚¯ãƒ¬ã‚¤ãƒ  ã‚’è¤‡æ•°é¸æŠå¯</li>
          <li><b>è¦å®š</b>â€¦ ä¸Šæ˜‡ç‡ãƒ»å£²è²·ä»£é‡‘ãƒ»RVOL ã®æ—¢å®šå€¤ã‚’ä¸€æ‹¬ã‚»ãƒƒãƒˆ</li>
        </ul>
        <p>åˆ—åã‚¯ãƒªãƒƒã‚¯ã§ã‚½ãƒ¼ãƒˆã€ã‚³ãƒ¼ãƒ‰ã®æ•°å­—ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚</p>
      </div>
    `);
  });

  // tabs
  function switchTab(to){
    state.tab = to;
    $$(".tab").forEach(el=>el.classList.add("hidden"));
    $$("nav a").forEach(a=>a.classList.remove("active"));
    if (to === "cand"){
      $("#tab-candidate")?.classList.remove("hidden");
      $("#lnk-cand")?.classList.add("active");
      state.data = DATA_CAND.slice();
      state.page = 1;
      render();
      return;
    }
    if (to === "tmr"){
      $("#tab-tmr")?.classList.remove("hidden");
      $("#lnk-tmr")?.classList.add("active");
      renderTomorrowWrapper();
      return;
    }
    if (to === "all"){
      $("#tab-all")?.classList.remove("hidden");
      $("#lnk-all")?.classList.add("active");
      state.page = 1;
      render();
      return;
    }
    if (to === "log"){
      $("#tab-log")?.classList.remove("hidden");
      $("#lnk-log")?.classList.add("active");
      const lb = $("#log-body");
      if (lb && !lb.getAttribute("data-inited")){
        lb.innerHTML = (DATA_LOG||[]).map(r=> `<tr><td>${r["æ—¥æ™‚"]||""}</td><td>${r["ã‚³ãƒ¼ãƒ‰"]||""}</td><td>${r["ç¨®åˆ¥"]||""}</td><td>${r["è©³ç´°"]||""}</td></tr>`).join("");
        lb.setAttribute("data-inited","1");
      }
      return;
    }
    if (to === "earn"){
      $("#tab-earn")?.classList.remove("hidden");
      $("#lnk-earn")?.classList.add("active");
      renderEarnings(DATA_EARN);
      return;
    }
    if (to === "preearn"){
      $("#tab-preearn")?.classList.remove("hidden");
      $("#lnk-preearn")?.classList.add("active");
      renderPreEarnings(DATA_PREEARN);
      return;
    }
  }
  (function(){
    const map = { "lnk-cand":"cand","lnk-tmr":"tmr","lnk-all":"all","lnk-log":"log","lnk-earn":"earn","lnk-preearn":"preearn" };
    Object.keys(map).forEach(id=>{
      const a = document.getElementById(id);
      if (!a) return;
      a.addEventListener("click", (e)=>{ e.preventDefault(); switchTab(map[id]); });
    });
  })();

  // initialï¼ˆã“ã“ã‚’å·®ã—æ›¿ãˆï¼‰
  window.addEventListener("DOMContentLoaded", () => {
    // 1) ã‚¿ãƒ–åˆæœŸåŒ–ï¼ˆã“ã®æ™‚ç‚¹ã§DOMãŒå‡ºæ¥ã¦ã„ã‚‹ã®ã§æç”»ã•ã‚Œã‚‹ï¼‰
    switchTab("cand");
    forceClearThresholds();

    // 2) 1è¡Œè¡¨ã§ã® <br> ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«ç½®æ›ï¼ˆå…ƒã®å‡¦ç†ã‚’çµ±åˆï¼‰
    document.querySelectorAll('#tbl-candidate td br, #tbl-allcols td br')
      .forEach(br => br.replaceWith(' '));
  });

})();
</script>



  <section id="tab-candidate" class="tab">
    <div class="tbl-wrap">
      <table id="tbl-candidate" class="tbl">
        <thead>
          <tr>
            <th class="sortable" data-col="ã‚³ãƒ¼ãƒ‰" data-type="text">ã‚³ãƒ¼ãƒ‰<span class="arrow"></span></th>
            <th class="sortable" data-col="éŠ˜æŸ„å" data-type="text">éŠ˜æŸ„<span class="arrow"></span></th>
            <th data-col="å¸‚å ´">å¸‚å ´</th>
            <th>Yahoo</th>
            <th>X</th>
            <th class="num sortable" data-col="ç¾åœ¨å€¤" data-type="num">ç¾åœ¨å€¤<span class="arrow"></span></th>
            <th class="num sortable" data-col="å‰æ—¥çµ‚å€¤" data-type="num">å‰æ—¥çµ‚å€¤<span class="arrow"></span></th>
            <th class="num sortable" data-col="å‰æ—¥å††å·®" data-type="num">å‰æ—¥æ¯”(å††)<span class="arrow"></span></th>
            <th class="num sortable" data-col="å‰æ—¥çµ‚å€¤æ¯”ç‡" data-type="num">å‰æ—¥çµ‚å€¤æ¯”ç‡ï¼ˆï¼…ï¼‰<span class="arrow"></span></th>
            <th class="num sortable" data-col="å‡ºæ¥é«˜" data-type="num">å‡ºæ¥é«˜<span class="arrow"></span></th>
            <th class="num sortable" data-col="å£²è²·ä»£é‡‘(å„„)" data-type="num">å£²è²·ä»£é‡‘(å„„)<span class="arrow"></span></th>
            <th>è²¡å‹™</th>
            <th class="sortable" data-col="overall_alpha" data-type="text">Î±<span class="arrow"></span></th>
            <th class="num sortable" data-col="ã‚¹ã‚³ã‚¢" data-type="num">ã‚¹ã‚³ã‚¢<span class="arrow"></span></th>
            <th class="num sortable" data-col="é€²æ—ç‡" data-type="num">é€²æ—ç‡<span class="arrow"></span></th>
            <th data-col="å¢—è³‡ãƒªã‚¹ã‚¯">å¢—è³‡ãƒªã‚¹ã‚¯</th>
            <th class="num sortable" data-col="å¢—è³‡ã‚¹ã‚³ã‚¢" data-type="num">å¢—è³‡ã‚¹ã‚³ã‚¢<span class="arrow"></span></th>
            <th class="reason-col" data-col="å¢—è³‡ç†ç”±">ç†ç”±</th>
            <th class="sortable" data-col="åˆå‹•ãƒ•ãƒ©ã‚°" data-type="text">åˆå‹•<span class="arrow"></span></th>
            <th class="sortable" data-col="åº•æ‰“ã¡ãƒ•ãƒ©ã‚°" data-type="text">åº•æ‰“ã¡<span class="arrow"></span></th>
            <th class="sortable" data-col="å³è‚©ä¸ŠãŒã‚Šãƒ•ãƒ©ã‚°" data-type="text">å³è‚©<span class="arrow"></span></th>
            <th class="sortable" data-col="å³è‚©æ—©æœŸãƒ•ãƒ©ã‚°" data-type="text">æ—©æœŸ<span class="arrow"></span></th>
            <th class="num sortable" data-col="å³è‚©æ—©æœŸã‚¹ã‚³ã‚¢" data-type="num">æ—©æœŸS<span class="arrow"></span></th>
            <th class="sortable" data-col="å³è‚©æ—©æœŸç¨®åˆ¥" data-type="text">å³è‚©æ—©æœŸç¨®åˆ¥<span class="arrow"></span></th>
            <th class="sortable" data-col="åˆ¤å®š" data-type="text">åˆ¤å®š<span class="arrow"></span></th>
            <th class="sortable reason-col" data-col="åˆ¤å®šç†ç”±" data-type="text">åˆ¤å®šç†ç”±<span class="arrow"></span></th>
            <th class="sortable" data-col="æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" data-type="text">æ¨å¥¨<span class="arrow"></span></th>
            <th class="num sortable" data-col="æ¨å¥¨æ¯”ç‡" data-type="num">æ¨å¥¨æ¯”ç‡%<span class="arrow"></span></th>
            <th class="sortable" data-col="ã‚·ã‚°ãƒŠãƒ«æ›´æ–°æ—¥" data-type="date">æ›´æ–°<span class="arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-tmr" class="tab hidden">
    <div class="tbl-wrap">
      <div id="tmr-label" style="margin:8px 0 4px;font-weight:800;font-size:16px;color:#0d3b66;"></div>
      <table id="tbl-tmr" class="tbl">
        <thead>
          <tr>
            <th class="sortable" data-col="ã‚³ãƒ¼ãƒ‰" data-type="text">ã‚³ãƒ¼ãƒ‰<span class="arrow"></span></th>
            <th class="sortable" data-col="éŠ˜æŸ„å" data-type="text">éŠ˜æŸ„<span class="arrow"></span></th>
            <th data-col="å¸‚å ´">å¸‚å ´</th>
            <th>Yahoo</th>
            <th>X</th>
            <th class="num sortable" data-col="ç¾åœ¨å€¤" data-type="num">ç¾åœ¨å€¤<span class="arrow"></span></th>
            <th class="num sortable" data-col="å‰æ—¥çµ‚å€¤æ¯”ç‡" data-type="num">å‰æ—¥çµ‚å€¤æ¯”ç‡ï¼ˆï¼…ï¼‰<span class="arrow"></span></th>
            <th class="num sortable" data-col="å£²è²·ä»£é‡‘(å„„)" data-type="num">å£²è²·ä»£é‡‘(å„„)<span class="arrow"></span></th>
            <th>è²¡å‹™</th>
            <th data-col="å¢—è³‡ãƒªã‚¹ã‚¯">å¢—è³‡ãƒªã‚¹ã‚¯</th>
            <th class="num sortable" data-col="å¢—è³‡ã‚¹ã‚³ã‚¢" data-type="num">å¢—è³‡ã‚¹ã‚³ã‚¢<span class="arrow"></span></th>
            <th class="reason-col" data-col="å¢—è³‡ç†ç”±">ç†ç”±</th>
            <th class="num sortable" data-col="å³è‚©æ—©æœŸã‚¹ã‚³ã‚¢" data-type="num">æ—©æœŸS<span class="arrow"></span></th>
            <th class="sortable" data-col="å³è‚©æ—©æœŸç¨®åˆ¥" data-type="text">å³è‚©æ—©æœŸç¨®åˆ¥<span class="arrow"></span></th>
            <th class="sortable" data-col="åˆ¤å®š" data-type="text">åˆ¤å®š<span class="arrow"></span></th>
            <th class="sortable" data-col="æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³" data-type="text">æ¨å¥¨<span class="arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="tab-all" class="tab hidden">
    <div class="tbl-wrap">
      <table id="tbl-allcols" class="tbl">
        <thead><tr id="all-head"></tr></thead>
        <tbody id="all-body"></tbody>
      </table>
    </div>
  </section>

  <section id="tab-earn" class="tab hidden">
    <div class="tbl-wrap">
      <table id="tbl-earn" class="tbl">
        <thead>
          <tr>
            <th>éŠ˜æŸ„</th>
            <th>ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆ</th>
            <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
            <th>è¦ç´„</th>
            <th>åˆ¤å®š</th>
            <th class="reason-col">ç†ç”±</th>
            <th>æ™‚åˆ»</th>
          </tr>
        </thead>
        <tbody id="earn-body"></tbody>
      </table>
     </div>
   </section>

  <section id="tab-preearn" class="tab hidden">
     <div class="tbl-wrap">
       <table id="tbl-preearn" class="tbl">
         <thead>
           <tr>
             <th>éŠ˜æŸ„</th>
             <th class="num sortable" data-col="pre_score" data-type="num">pre_score<span class="arrow"></span></th>
             <th class="num sortable" data-col="edge_score" data-type="num">edge_score<span class="arrow"></span></th>
             <th class="num sortable" data-col="momentum_score" data-type="num">momentum_score<span class="arrow"></span></th>
             <th class="sortable reason-col" data-col="ã‚¹ã‚³ã‚¢ç†ç”±" data-type="text">ã‚¹ã‚³ã‚¢ç†ç”±<span class="arrow"></span></th>
             <th class="sortable" data-col="äºˆæ¸¬ãƒ’ãƒ³ãƒˆ" data-type="text">äºˆæ¸¬ãƒ’ãƒ³ãƒˆ<span class="arrow"></span></th>
             <th class="num sortable" data-col="æœŸå¾…æ ªä¾¡" data-type="num">æœŸå¾…æ ªä¾¡<span class="arrow"></span></th>
             <th class="sortable" data-col="ä¿®æ­£è¦‹é€šã—" data-type="text">ä¿®æ­£è¦‹é€šã—<span class="arrow"></span></th>
             <th class="sortable" data-col="éç†±åº¦" data-type="text">éç†±åº¦<span class="arrow"></span></th>
           </tr>
         </thead>
         <tbody id="preearn-body"></tbody>
       </table>
     </div>
  </section>

  {% if include_log %}
  <section id="tab-log" class="tab hidden">
    <div class="tbl-wrap">
      <table id="tbl-log" class="tbl">
        <thead>
          <tr>
            <th class="sortable" data-col="æ—¥æ™‚" data-type="date">æ—¥æ™‚<span class="arrow"></span></th>
            <th class="sortable" data-col="ã‚³ãƒ¼ãƒ‰" data-type="text">ã‚³ãƒ¼ãƒ‰<span class="arrow"></span></th>
            <th class="sortable" data-col="ç¨®åˆ¥" data-type="text">ç¨®åˆ¥<span class="arrow"></span></th>
            <th class="sortable" data-col="è©³ç´°" data-type="text">è©³ç´°<span class="arrow"></span></th>
          </tr>
        </thead>
        <tbody id="log-body"></tbody>
      </table>
    </div>
  </section>
  {% endif %}

</body>
</html>